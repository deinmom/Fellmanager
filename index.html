<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Fellmanager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    /* ... (Deine bisherigen Styles) ... */
  </style>
</head>
<body>
  <header>Fellmanager</header>
  <!-- Toolbar & Panels wie gehabt -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // 1) Client initialisieren in einer anderen Variable:
    const SUPABASE_URL = 'https://owrfgjypnemsxonmbrpj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cmZnanlwbmVtc3hvbm1icnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMTUyOTgsImV4cCI6MjA2Mjg5MTI5OH0.X1PymyDZqNe_Plmao8U6gdqFKP70VrFtuZTesgyZMwg';
    const ADMIN        = 'Admin';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 2) Rest der Referenzen auf sb statt supabase:
    const headers = { apikey: SUPABASE_KEY, Authorization: 'Bearer ' + SUPABASE_KEY };

    let adminMode = false, allData = [], filters = { typ: null, hersteller: null, serie: null },
        curMan, curField, curValue;

    // UI-Elemente referenzieren …
    const btnHome    = document.getElementById('btnHome'),
          btnAdmin   = document.getElementById('btnAdmin'),
          btnLogout  = document.getElementById('btnLogout'),
          btnSettings= document.getElementById('btnSettings'),
          btnImport  = document.getElementById('btnImport'),
          btnExport  = document.getElementById('btnExport'),
          btnFilter  = document.getElementById('btnFilter'),
          btnHistory = document.getElementById('btnHistory'),
          fileInput  = document.getElementById('fileInput'),
          setPanel   = document.getElementById('settingsPanel'),
          filtPanel  = document.getElementById('filterPanel'),
          histPanel  = document.getElementById('historyPanel'),
          inpWarn    = document.getElementById('warnschwelle'),
          inpTol     = document.getElementById('tolerance'),
          inpMail    = document.getElementById('emailTo'),
          btnSave    = document.getElementById('saveSettings'),
          spanStat   = document.getElementById('saveStatus'),
          filtTyp    = document.getElementById('filterTyp'),
          filtHerst  = document.getElementById('filterHersteller'),
          filtSerie  = document.getElementById('filterSerie'),
          btnClear   = document.getElementById('btnClearFilters'),
          histSelect = document.getElementById('historySelect'),
          histList   = document.getElementById('historyList'),
          menu       = document.getElementById('menu'),
          submenu    = document.getElementById('submenu'),
          cards      = document.getElementById('cards');

    // 3) Einstellungen laden
    async function loadSettings() {
      const { data } = await sb.from('settings')
        .select('warnschwelle,tolerance,email_to')
        .eq('id','global')
        .single();
      inpWarn.value = data.warnschwelle;
      inpTol.value  = data.tolerance;
      inpMail.value = data.email_to;
    }

    btnSave.onclick = async () => {
      spanStat.textContent = '…';
      await sb.from('settings')
        .update({
          warnschwelle: parseInt(inpWarn.value),
          tolerance:    parseInt(inpTol.value),
          email_to:     inpMail.value
        })
        .eq('id','global');
      spanStat.textContent = '✔️';
    };

    // 4) Daten laden
    async function loadData() {
      const { data } = await sb.from('felle')
        .select('*,typ_a,typ_b')
        .order('hersteller',{ascending:true});
      allData = data;
    }

    // 5) Init
    await loadSettings();
    await loadData();

    // … Rest Deines Scripts unverändert, **aber** überall:
    //   supabase.from → sb.from
    //   supabase.createClient wird nicht mehr verwendet

    // Beispiel für den Upsert-Import:
    fileInput.onchange = async () => {
      const text = await fileInput.files[0].text();
      // … CSV einlesen …

      // Upsert:
      const { error } = await sb.from('felle').upsert(upsertArray, { onConflict:'id' });
      if(error) return alert('Import-Fehler: '+error.message);
      await loadData();
      renderMenu();
      alert('Import abgeschlossen');
    };

    // … und so weiter für alle fetch- und updateAufrufe …

    renderMenu();
  });
  </script>
</body>
</html>
