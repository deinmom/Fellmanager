<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Fellmanager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { margin:0; font-family:sans-serif; background:#f5f5f5; }
    header { background:#3182ce; color:white; padding:1rem; text-align:center; font-size:1.5rem; position:sticky; top:0; }
    #toolbar { padding:1rem; display:flex; flex-wrap:wrap; gap:.5rem; background:#fff; }
    .btn { padding:.5rem 1rem; border:none; border-radius:.25rem; cursor:pointer; }
    .btn-admin { background:#3182ce; color:white; }
    .btn-logout { background:#e53e3e; color:white; }
    .btn-import { background:#d69e2e; color:white; }
    .btn-export { background:#2f855a; color:white; }
    .btn-filter { background:#4a5568; color:white; }
    .btn-history { background:#805ad5; color:white; }
    #menu, #submenu, #cards, #settingsPanel, #filterPanel, #historyPanel { padding:1rem; }
    #settingsPanel, #filterPanel, #historyPanel { background:#fff; margin:1rem; border-radius:.5rem; display:none; }
    .section { margin:1rem 0 .5rem; font-weight:bold; }
    .card { background:#fff; border-radius:1rem; padding:1rem; margin:.5rem 1rem; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .title { font-weight:bold; }
    .wiki { font-size:.9rem; color:#555; margin:.5rem 0; }
    .controls { display:flex; justify-content:space-between; align-items:center; margin-top:.5rem; }
    .controls button { border:none; padding:.3rem .7rem; border-radius:.25rem; color:white; cursor:pointer; }
    .minus { background:#e53e3e; }
    .plus  { background:#38a169; }
    input.stock-input, input.tol-input { width:4rem; margin-right:.5rem; }
    #fileInput { display:none; }
    select#historySelect { width:100%; padding:.5rem; margin-bottom:.5rem; }
    #historyList { max-height:200px; overflow:auto; background:#fff; padding:.5rem; border-radius:.5rem; }
  </style>
</head>
<body>
  <header>Fellmanager</header>
  <div id="toolbar">
    <button id="btnAdmin"   class="btn btn-admin">Admin Modus</button>
    <button id="btnLogout"  class="btn btn-logout" style="display:none;">Logout Admin</button>
    <button id="btnImport"  class="btn btn-import"  style="display:none;">CSV importieren</button>
    <button id="btnExport"  class="btn btn-export">CSV exportieren</button>
    <button id="btnFilter"  class="btn btn-filter">Filter</button>
    <button id="btnHistory" class="btn btn-history">Historie</button>
    <input  type="file" id="fileInput" accept=".csv"/>
  </div>

  <div id="settingsPanel">
    <h2>Einstellungen</h2>
    <label>Warnschwelle: <input type="number" id="warnschwelle"/></label><br/>
    <label>Globale Toleranz: <input type="number" id="tolerance"/></label><br/>
    <label>Warn-Mail an: <input type="email" id="emailTo" style="width:200px"/></label><br/>
    <button id="saveSettings" class="btn">Speichern</button>
    <span id="saveStatus" style="margin-left:1rem;"></span>
  </div>

  <div id="filterPanel">
    <h2>Filter</h2>
    <div class="section">Typ</div><div id="filterTyp"></div>
    <div class="section">Hersteller</div><div id="filterHersteller"></div>
    <div class="section">Serie</div><div id="filterSerie"></div>
    <button id="btnClearFilters" class="btn">Filter zurücksetzen</button>
  </div>

  <div id="historyPanel">
    <h2>Historie</h2>
    <select id="historySelect"><option value="">– Fell wählen –</option></select>
    <div id="historyList">Keine Historie.</div>
  </div>

  <div id="menu"></div>
  <div id="submenu" style="display:none;"></div>
  <div id="cards"></div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const URL        = 'https://owrfgjypnemsxonmbrpj.supabase.co';
    const KEY        = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cmZnanlwbmVtc3hvbm1icnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMTUyOTgsImV4cCI6MjA2Mjg5MTI5OH0.X1PymyDZqNe_Plmao8U6gdqFKP70VrFtuZTesgyZMwg';
    const FORM_ID    = 'xeogngrz';
    const ADMIN_PASS = 'Admin';
    const headers    = { apikey:KEY, Authorization:'Bearer '+KEY };

    // UI Refs
    const btnAdmin    = document.getElementById('btnAdmin'),
          btnLogout   = document.getElementById('btnLogout'),
          btnImport   = document.getElementById('btnImport'),
          btnExport   = document.getElementById('btnExport'),
          btnFilter   = document.getElementById('btnFilter'),
          btnHistory  = document.getElementById('btnHistory'),
          fileInput   = document.getElementById('fileInput'),
          settingsDiv = document.getElementById('settingsPanel'),
          filterDiv   = document.getElementById('filterPanel'),
          historyDiv  = document.getElementById('historyPanel'),
          inpWarn     = document.getElementById('warnschwelle'),
          inpTol      = document.getElementById('tolerance'),
          inpMail     = document.getElementById('emailTo'),
          btnSave     = document.getElementById('saveSettings'),
          spanStat    = document.getElementById('saveStatus'),
          container   = document.getElementById('cards'),
          menu        = document.getElementById('menu'),
          submenu     = document.getElementById('submenu'),
          filterTyp   = document.getElementById('filterTyp'),
          filterHerst = document.getElementById('filterHersteller'),
          filterSer   = document.getElementById('filterSerie'),
          btnClear    = document.getElementById('btnClearFilters'),
          historySel  = document.getElementById('historySelect'),
          historyList = document.getElementById('historyList');

    let adminMode=false, warnschwelle=0, tolerance=0, emailTo='', allData=[], filters={typ:null,hersteller:null,serie:null};
    let currentManufacturer=null, currentView=null, currentFilterValue=null;

    // Admin Login/Logout
    btnAdmin.onclick = ()=>{ const pw=prompt('Admin-Passwort eingeben:'); 
      if(pw===ADMIN_PASS){
        adminMode=true;
        settingsDiv.style.display='block';
        btnAdmin.style.display='none';
        btnLogout.style.display='inline-block';
        btnImport.style.display='inline-block';
        loadSettings();
      }
    };
    btnLogout.onclick = ()=>{
      adminMode=false;
      settingsDiv.style.display='none';
      submenu.style.display='none';
      menu.style.display='';
      container.style.display='none';
      filterDiv.style.display='none';
      historyDiv.style.display='none';
      btnLogout.style.display='none';
      btnAdmin.style.display='inline-block';
      btnImport.style.display='none';
    };

    // Load settings & data
    async function loadSettings(){
      const res=await fetch(`${URL}/rest/v1/settings?select=warnschwelle,tolerance,email_to&id=eq.global`,{headers});
      const [s]=await res.json();
      warnschwelle=s.warnschwelle; tolerance=s.tolerance; emailTo=s.email_to;
      inpWarn.value=warnschwelle; inpTol.value=tolerance; inpMail.value=emailTo;
    }
    btnSave.onclick=async()=>{
      spanStat.textContent='Speichern…';
      const body={warnschwelle:parseInt(inpWarn.value,10),tolerance:parseInt(inpTol.value,10),email_to:inpMail.value};
      const r=await fetch(`${URL}/rest/v1/settings?id=eq.global`,{method:'PATCH',headers,body:JSON.stringify(body)});
      spanStat.textContent=r.ok?'✔️':'❌';
    };
    async function fetchData(){
      const res=await fetch(`${URL}/rest/v1/felle?select=*,typ_a,typ_b&order=hersteller,serie,groesse`,{headers});
      allData=await res.json();
    }
    await fetchData();

    // Toolbar buttons
    btnFilter.onclick = ()=>{ filterDiv.style.display = filterDiv.style.display==='block'?'none':'block'; buildFilter(); };
    btnHistory.onclick=()=>{ historyDiv.style.display='block'; buildHistoryDropdown(); };
    btnClear.onclick={()=>{ filters={typ:null,hersteller:null,serie:null}; buildFilter(); renderMenu(); }};
    fileInput.onchange=async()=>{
      const txt=await fileInput.files[0].text();
      const lines=txt.split(/\r?\n/).filter(l=>l.trim());
      const sep=lines[0].includes(';')?';':',';
      const [hdr,...rows]=lines.map(l=>l.split(sep).map(c=>c.trim()));
      const idIdx=hdr.indexOf('id'), stIdx=hdr.indexOf('bestand');
      for(const cols of rows){
        const id=cols[idIdx], st=parseInt(cols[stIdx],10);
        if(id && !isNaN(st)){
          const old=allData.find(f=>f.id===id).bestand;
          await updateAndLog(id, st-old);
        }
      }
      alert('Import abgeschlossen');
    };
    btnExport.onclick=async()=>{
      const sep=';';
      const keys=Object.keys(allData[0]);
      let csv=keys.join(sep)+'\n';
      allData.forEach(f=>{ csv+=keys.map(k=>f[k]===null?'':String(f[k]).replace(/"/g,'""')).join(sep)+'\n'; });
      const blob=new Blob([csv],{type:'text/csv'}), dl=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=dl; a.download='COPY4DATABASE.csv'; document.body.append(a); a.click(); a.remove(); URL.revokeObjectURL(dl);
    };

    // History dropdown
    async function buildHistoryDropdown(){
      historySel.innerHTML='<option></option>';
      allData.forEach(f=>historySel.add(new Option(`${f.hersteller}–${f.serie} ${f.groesse}`,f.id)));
    }
    historySel.onchange=async()=>{
      const id=historySel.value;
      if(!id){ historyList.textContent='Keine Historie.'; return; }
      const res=await fetch(`${URL}/rest/v1/history?select=delta,timestamp&fell_id=eq.${id}&order=timestamp.desc`,{headers});
      const hs=await res.json();
      historyList.innerHTML=hs.map(h=>`<div>${new Date(h.timestamp).toLocaleString()}: ${h.delta>0?'+':''}${h.delta}</div>`).join('')||'Keine Einträge.';
    };

    // Filters
    function buildFilter(){
      ['Typ','Hersteller','Serie'].forEach((sec,i)=>{
        const ct=[filterTyp,filterHerst,filterSer][i];
        const vals = Array.from(new Set(
          allData.filter(f=>!filters.hersteller||f.hersteller===filters.hersteller)
                 .flatMap(f=> i===0?[f.typ_a,f.typ_b].filter(Boolean) : i===1?[f.hersteller] : [f.serie])
        )).sort();
        ct.innerHTML=''; vals.forEach(v=>{
          const b=document.createElement('button'); b.textContent=v; b.className='btn';
          if(filters[['typ','hersteller','serie'][i]]===v) b.style.background='#2b6cb0';
          b.onclick=()=>{ filters[['typ','hersteller','serie'][i]] = filters[['typ','hersteller','serie'][i]]===v?null:v; buildFilter(); renderMenu(); };
          ct.appendChild(b);
        });
      });
    }

    // Menu flow
    btnAdmin.disabled=false;
    document.getElementById('btnHistoryView'); // ensure
  
    function renderMenu(){
      menu.innerHTML='<h2>Wähle Hersteller</h2>'; submenu.style.display='none'; historyDiv.style.display='none'; cards.style.display='none';
      const hers = Array.from(new Set(allData.map(f=>f.hersteller))).filter(h=> !filters.hersteller||h===filters.hersteller);
      hers.sort().forEach(h=>{
        const b=document.createElement('button'); b.textContent=h; b.className='btn';
        b.onclick=()=>showSubmenu(h);
        menu.appendChild(b);
      });
    }
    function showSubmenu(man){
      currentManufacturer = man;
      menu.style.display='none'; historyDiv.style.display='none'; cards.style.display='none';
      submenu.style.display='block'; submenu.innerHTML='';
      const back=document.createElement('button'); back.textContent='← Zurück'; back.className='btn btn-logout';
      back.onclick=()=>{ menu.style.display='block'; submenu.style.display='none'; };
      submenu.append(back);
      ['Nach Serie','Nach Typ'].forEach((txt,i)=>{
        const b=document.createElement('button'); b.textContent=txt; b.className='btn';
        b.onclick=()=>showList(i===0?'serie':'typ');
        submenu.append(b);
      });
    }
    function showList(mode){
      submenu.style.display='none'; cards.style.display='block'; cards.innerHTML='';
      const back=document.createElement('button'); back.textContent='← Zurück'; back.className='btn btn-logout';
      back.onclick=()=>showSubmenu(currentManufacturer);
      cards.append(back);
      const items = mode==='serie'
        ? Array.from(new Set(allData.filter(f=>f.hersteller===currentManufacturer).map(f=>f.serie)))
        : Array.from(new Set(allData.filter(f=>f.hersteller===currentManufacturer).flatMap(f=>[f.typ_a,f.typ_b].filter(Boolean))));
      items.sort().forEach(v=>{
        const b=document.createElement('button'); b.textContent=v; b.className='btn';
        b.onclick=()=>{
          renderCards(mode, v);
        };
        cards.append(b);
      });
    }
    function renderCards(filterBy, value){
      cards.scrollTop=0;
      cards.innerHTML='';
      const back=document.createElement('button'); back.textContent='← Zurück'; back.className='btn btn-logout';
      back.onclick=()=>showList(filterBy);
      cards.append(back);
      allData.filter(f=>{
        if(f.hersteller!==currentManufacturer) return false;
        return filterBy==='serie'
          ? f.serie===value
          : (f.typ_a===value||f.typ_b===value);
      }).forEach(f=>{
        const c=document.createElement('div'); c.className='card';
        const t=document.createElement('div'); t.className='title';
        t.textContent=`${f.serie} ${f.groesse}`; c.append(t);
        const w=document.createElement('div'); w.className='wiki'; w.textContent=f.wiki||''; c.append(w);
        const ctr=document.createElement('div'); ctr.className='controls';
        if(adminMode){
          const si=document.createElement('input'); si.type='number'; si.value=f.bestand; si.className='stock-input';
          si.onchange=()=>updateAndLog(f.id, parseInt(si.value,10)-f.bestand);
          ctr.append(si);
        } else {
          const bd=document.createElement('div'); bd.innerHTML=`Bestand: <strong>${f.bestand}</strong>`; ctr.append(bd);
        }
        ['minus','plus'].forEach(m=>{
          const b=document.createElement('button'); b.className=m; b.textContent=m==='minus'?'-1':'+1';
          b.onclick=()=>updateAndLog(f.id, m==='minus'?-1:+1);
          ctr.append(b);
        });
        c.append(ctr); cards.append(c);
      });
    }

    async function updateAndLog(id, delta){
      if(delta===0) return;
      const f=allData.find(x=>x.id===id), neu=f.bestand+delta;
      await fetch(`${URL}/rest/v1/felle?id=eq.${id}`,{
        method:'PATCH',headers:{...headers,'Content-Type':'application/json'},body:JSON.stringify({bestand:neu})
      });
      await fetch(`${URL}/rest/v1/history`,{
        method:'POST',headers:{...headers,'Content-Type':'application/json'},body:JSON.stringify({fell_id:id,delta})
      });
      f.bestand=neu;
      renderCards(currentFilterValue, currentFilterValue);
    }

    // Init
    buildFilter();
    renderMenu();
  });
  </script>
</body>
</html>
