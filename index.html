<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Fellmanager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { max-width:700px; margin:2rem auto; font-family:sans-serif; }
    .header { font-size:24px; font-weight:bold; text-align:center; margin:1rem 0; }
    .btn { padding:.5rem 1rem; margin:0 .5rem .5rem 0; cursor:pointer; border:none; border-radius:.25rem; }
    .btn-admin { background:#3182ce; color:white; }
    .btn-logout { background:#e53e3e; color:white; }
    .btn-import { background:#d69e2e; color:white; }
    .btn-export { background:#2f855a; color:white; }
    .btn-filter { background:#4a5568; color:white; }
    #settingsPanel, #filterPanel { border:1px solid #888; padding:1rem; margin-bottom:2rem; border-radius:.5rem; display:none; }
    #settingsPanel label, #filterPanel .section { display:block; margin:.5rem 0 .2rem; }
    #settingsPanel input, #filterPanel button { padding:.2rem; margin-right:.5rem; }
    #settingsPanel button { margin-top:1rem; }
    .card { border:1px solid #ccc; border-radius:1rem; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .title { font-size:18px; font-weight:bold; }
    .wiki  { font-size:14px; color:#555; margin:.5rem 0; }
    .controls { display:flex; flex-wrap: wrap; justify-content:space-between; align-items:center; }
    .controls > div { margin:.3rem; }
    .controls button, .controls input { margin-right:.5rem; }
    .minus { background:#e53e3e; color:white; }
    .plus  { background:#38a169; color:white; }
    .tol-input, .stock-input { width:4rem; }
    #fileInput { display:none; }
    .active-filter { background:#2b6cb0 !important; }
  </style>
</head>
<body>
  <div class="header">Fellmanager</div>
  <div>
    <button id="btnAdmin" class="btn btn-admin">Admin Modus</button>
    <button id="btnLogout" class="btn btn-logout" style="display:none;">Logout Admin</button>
    <button id="btnImport" class="btn btn-import" style="display:none;">CSV importieren</button>
    <button id="btnExport" class="btn btn-export">CSV exportieren</button>
    <button id="btnFilter" class="btn btn-filter">Filter</button>
    <input type="file" id="fileInput" accept=".csv" />
  </div>

  <div id="settingsPanel">
    <h2>Einstellungen</h2>
    <label>Warnschwelle:
      <input type="number" id="warnschwelle" />
    </label>
    <label>Globale Toleranz:
      <input type="number" id="tolerance" />
    </label>
    <label>Warn-Mail an:
      <input type="email" id="emailTo" style="width:200px" />
    </label>
    <button id="saveSettings" class="btn">Speichern</button>
    <span id="saveStatus" style="margin-left:1rem;"></span>
  </div>

  <div id="filterPanel">
    <h2>Filter</h2>
    <div class="section"><strong>Typ</strong></div>
    <div id="filterTyp"></div>
    <div class="section"><strong>Hersteller</strong></div>
    <div id="filterHersteller"></div>
    <div class="section"><strong>Serie</strong></div>
    <div id="filterSerie"></div>
    <button id="btnClearFilters" class="btn">Alle Filter zurücksetzen</button>
  </div>

  <div id="container">Lade Daten…</div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const URL        = 'https://owrfgjypnemsxonmbrpj.supabase.co';
    const KEY        = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cmZnanlwbmVtc3hvbm1icnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMTUyOTgsImV4cCI6MjA2Mjg5MTI5OH0.X1PymyDZqNe_Plmao8U6gdqFKP70VrFtuZTesgyZMwg';
    const FORM_ID    = 'xeogngrz';
    const ADMIN_PASS = 'Admin';
    const headers = { apikey:KEY, Authorization:'Bearer '+KEY, 'Content-Type':'application/json' };

    // UI refs
    const btnAdmin  = document.getElementById('btnAdmin'),
          btnLogout = document.getElementById('btnLogout'),
          btnImport = document.getElementById('btnImport'),
          btnExport = document.getElementById('btnExport'),
          btnFilter = document.getElementById('btnFilter'),
          fileInput = document.getElementById('fileInput'),
          settingsDiv = document.getElementById('settingsPanel'),
          filterDiv   = document.getElementById('filterPanel'),
          inpWarn = document.getElementById('warnschwelle'),
          inpTol  = document.getElementById('tolerance'),
          inpMail = document.getElementById('emailTo'),
          btnSave = document.getElementById('saveSettings'),
          spanStat= document.getElementById('saveStatus'),
          container= document.getElementById('container'),
          filterTyp = document.getElementById('filterTyp'),
          filterHersteller = document.getElementById('filterHersteller'),
          filterSerie = document.getElementById('filterSerie'),
          btnClearFilters = document.getElementById('btnClearFilters');

    let adminMode=false, warnschwelle=0, tolerance=0, emailTo='',
        allData=[], filters={typ:null, hersteller:null, serie:null};

    // Admin handlers
    btnAdmin.onclick = ()=>{
      const pw=prompt('Admin-Passwort:');
      if(pw===ADMIN_PASS){
        adminMode=true;
        settingsDiv.style.display='block';
        btnAdmin.style.display='none';
        btnLogout.style.display='inline-block';
        btnImport.style.display='inline-block';
        loadSettings();
        loadFelle();
      }
    };
    btnLogout.onclick = ()=>{
      adminMode=false;
      settingsDiv.style.display='none';
      filterPanelReset();
      btnLogout.style.display='none';
      btnAdmin.style.display='inline-block';
      btnImport.style.display='none';
      loadFelle();
    };

    // settings
    async function loadSettings(){
      const res=await fetch(`${URL}/rest/v1/settings?select=warnschwelle,tolerance,email_to&id=eq.global`,{headers});
      const [s]=await res.json();
      warnschwelle=s.warnschwelle; tolerance=s.tolerance; emailTo=s.email_to;
      inpWarn.value=warnschwelle; inpTol.value=tolerance; inpMail.value=emailTo;
    }
    btnSave.onclick=async ()=>{
      spanStat.textContent='Speichern…';
      try{
        const body={warnschwelle:parseInt(inpWarn.value,10),tolerance:parseInt(inpTol.value,10),email_to:inpMail.value};
        const res=await fetch(`${URL}/rest/v1/settings?id=eq.global`,{
          method:'PATCH',headers,body:JSON.stringify(body)
        });
        if(!res.ok)throw '';
        warnschwelle=body.warnschwelle; tolerance=body.tolerance; emailTo=body.email_to;
        spanStat.textContent='✔️'; setTimeout(()=>spanStat.textContent='',1500);
      }catch{spanStat.textContent='❌';}
    };

    // filter panel toggle
    btnFilter.onclick=()=>{
      filterDiv.style.display = filterDiv.style.display==='block'?'none':'block';
      if(filterDiv.style.display==='block') buildFilterButtons();
    };
    btnClearFilters.onclick=()=>{
      filters={typ:null,hersteller:null,serie:null};
      buildFilterButtons(); renderCards(allData);
    };

    // load data & render
    async function loadFelle(){
      container.textContent='Lade Daten…';
      const res=await fetch(`${URL}/rest/v1/felle?select=*,typ_a,typ_b&order=serie.asc`,{headers});
      allData=await res.json();
      buildFilterButtons();
      renderCards(allData);
    }

    function buildFilterButtons(){
      // distinct lists
      const typs = Array.from(new Set(allData.flatMap(f=>[f.typ_a,f.typ_b].filter(Boolean))));
      const hers = Array.from(new Set(allData.map(f=>f.hersteller)));
      const series=Array.from(new Set(allData.map(f=>f.serie)));

      // helper
      function makeBtns(container, arr, key){
        container.innerHTML='';
        arr.forEach(val=>{
          const b=document.createElement('button');
          b.textContent=val;
          b.className='btn';
          if(filters[key]===val) b.classList.add('active-filter');
          b.onclick=()=>{
            filters[key]=filters[key]===val?null:val;
            makeBtns(container,arr,key);
            renderCards(allData);
          };
          container.appendChild(b);
        });
      }

      makeBtns(filterTyp, typs, 'typ');
      makeBtns(filterHersteller, hers, 'hersteller');
      makeBtns(filterSerie, series,'serie');
    }

    function renderCards(data){
      container.innerHTML='';
      data.filter(f=>{
        if(filters.typ && !(f.typ_a===filters.typ||f.typ_b===filters.typ)) return false;
        if(filters.hersteller && f.hersteller!==filters.hersteller) return false;
        if(filters.serie && f.serie!==filters.serie) return false;
        return true;
      }).forEach(renderCard);
    }

    function renderCard(f){
      const card=document.createElement('div'); card.className='card';
      const title=document.createElement('div'); title.className='title';
      title.textContent=`${f.hersteller} – ${f.serie} ${f.groesse}`; card.appendChild(title);
      const wiki=document.createElement('div'); wiki.className='wiki';
      wiki.textContent=f.wiki||''; card.appendChild(wiki);

      const ctr=document.createElement('div'); ctr.className='controls';
      // inline stock
      if(adminMode){
        const si=document.createElement('input');
        si.type='number'; si.value=f.bestand; si.className='stock-input';
        si.onchange=()=>updateItem({id:f.id, bestand:parseInt(si.value,10)});
        ctr.appendChild(si);
      } else {
        const bd=document.createElement('div');
        bd.innerHTML=`Bestand: <strong>${f.bestand}</strong>`; ctr.appendChild(bd);
      }
      // +/- buttons
      const btns=document.createElement('div');
      ['minus','plus'].forEach(mode=>{
        const b=document.createElement('button');
        b.className=mode; b.textContent=mode==='minus'?'-1':'+1';
        b.onclick=()=>changeBestand(f.id, mode==='minus'?-1:1);
        btns.appendChild(b);
      });
      ctr.appendChild(btns);
      // per-item tol
      if(adminMode){
        const ti=document.createElement('input');
        ti.type='number'; ti.value=f.tolerance_per_item!=null?f.tolerance_per_item:'';
        ti.placeholder='tol'; ti.className='tol-input';
        ti.onchange=()=>updateItem({id:f.id,
          tolerance_per_item:ti.value===''?null:parseInt(ti.value,10)});
        ctr.appendChild(ti);
      }
      card.appendChild(ctr);
      container.appendChild(card);
    }

    async function updateItem(ch){
      await fetch(`${URL}/rest/v1/felle?id=eq.${encodeURIComponent(ch.id)}`,{
        method:'PATCH',headers,body:JSON.stringify(ch)
      });
      // update local and re-render
      const idx=allData.findIndex(x=>x.id===ch.id);
      Object.assign(allData[idx],ch);
      renderCards(allData);
    }

    async function changeBestand(id,delta){
      const f=allData.find(x=>x.id===id);
      const neu=f.bestand+delta;
      await updateItem({id, bestand:neu});
      if(!f.skip_email){
        const tol=f.tolerance_per_item!=null?f.tolerance_per_item:tolerance;
        if(neu<=warnschwelle+tol) await sendAlertWithList();
      }
    }

    // CSV Import/Export unchanged...
    btnImport.onclick=()=>fileInput.click();
    fileInput.onchange=...; // (wie gehabt)
    btnExport.onclick=...;

    // Warn-Mail
    async function sendAlertWithList(){ /* ... */ }

    // init
    await loadSettings();
    await loadFelle();
  });
  </script>
</body>
</html>
