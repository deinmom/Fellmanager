<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Fellmanager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { max-width:700px; margin:2rem auto; font-family:sans-serif; }
    .header { font-size:24px; font-weight:bold; text-align:center; margin:1rem 0; }
    .btn { padding:.5rem 1rem; margin:0 .5rem .5rem 0; cursor:pointer; border:none; border-radius:.25rem; }
    .btn-admin { background:#3182ce; color:white;}
    .btn-logout{ background:#e53e3e;color:white;}
    .btn-import{ background:#d69e2e;color:white;}
    .btn-export{ background:#2f855a;color:white;}
    .btn-filter{ background:#4a5568;color:white;}
    #settingsPanel,#filterPanel{border:1px solid #888;padding:1rem;margin-bottom:2rem;border-radius:.5rem;display:none;}
    #settingsPanel label{display:block;margin:.5rem 0 .2rem;}
    #settingsPanel input{width:4rem;padding:.2rem;}
    #filterPanel .section{margin:.5rem 0 .2rem;}
    #filterPanel button{margin:.25rem .25rem .5rem 0;padding:.3rem .6rem;}
    .active-filter{background:#2b6cb0!important;}
    .card{border:1px solid #ccc;border-radius:1rem;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .title{font-size:18px;font-weight:bold;}
    .wiki{font-size:14px;color:#555;margin:.5rem 0;}
    .controls{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;}
    .controls>div{margin:.3rem;}
    .controls button,.controls input{margin-right:.5rem;}
    .minus{background:#e53e3e;color:white;}
    .plus{background:#38a169;color:white;}
    .stock-input,.tol-input{width:4rem;}
    #fileInput{display:none;}
    #historyPanel{display:none;margin-top:1rem;}
    #historySelect{width:100%;max-width:300px;margin-bottom:.5rem;}
    #historyList{max-height:200px;overflow:auto;border:1px solid #ccc;padding:.5rem;border-radius:.5rem;background:#fafafa;}
    #historyList div{margin:.2rem 0;font-size:14px;}
  </style>
</head>
<body>
  <div class="header">Fellmanager</div>
  <div>
    <button id="btnAdmin"   class="btn btn-admin">Admin Modus</button>
    <button id="btnLogout"  class="btn btn-logout" style="display:none;">Logout Admin</button>
    <button id="btnImport"  class="btn btn-import"  style="display:none;">CSV importieren</button>
    <button id="btnExport"  class="btn btn-export">CSV exportieren</button>
    <button id="btnFilter"  class="btn btn-filter">Filter</button>
    <input  type="file"    id="fileInput" accept=".csv"/>
  </div>

  <div id="settingsPanel">
    <h2>Einstellungen</h2>
    <label>Warnschwelle:
      <input type="number" id="warnschwelle"/>
    </label>
    <label>Globale Toleranz:
      <input type="number" id="tolerance"/>
    </label>
    <label>Warn-Mail an:
      <input type="email" id="emailTo" style="width:200px"/>
    </label>
    <button id="saveSettings" class="btn">Speichern</button>
    <span id="saveStatus" style="margin-left:1rem;"></span>
  </div>

  <div id="filterPanel">
    <h2>Filter</h2>
    <div class="section"><strong>Typ</strong></div><div id="filterTyp"></div>
    <div class="section"><strong>Hersteller</strong></div><div id="filterHersteller"></div>
    <div class="section"><strong>Serie</strong></div><div id="filterSerie"></div>
    <button id="btnHistoryView" class="btn">Historie ansehen</button>
    <button id="btnClearFilters" class="btn">Filter zurücksetzen</button>
  </div>

  <div id="historyPanel">
    <select id="historySelect"></select>
    <div id="historyList">Keine Historie geladen.</div>
  </div>

  <div id="container">Lade Daten…</div>

  <script>
  document.addEventListener('DOMContentLoaded', async() => {
    const URL        = 'https://owrfgjypnemsxonmbrpj.supabase.co';
    const KEY        = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cmZnanlwbmVtc3hvbm1icnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMTUyOTgsImV4cCI6MjA2Mjg5MTI5OH0.X1PymyDZqNe_Plmao8U6gdqFKP70VrFtuZTesgyZMwg';
    const FORM_ID    = 'xeogngrz';
    const ADMIN_PASS = 'Admin';
    const headers    = { apikey:KEY, Authorization:'Bearer '+KEY,'Content-Type':'application/json' };

    // UI-Refs
    const btnAdmin    = document.getElementById('btnAdmin'),
          btnLogout   = document.getElementById('btnLogout'),
          btnImport   = document.getElementById('btnImport'),
          btnExport   = document.getElementById('btnExport'),
          btnFilter   = document.getElementById('btnFilter'),
          fileInput   = document.getElementById('fileInput'),
          settingsDiv = document.getElementById('settingsPanel'),
          filterDiv   = document.getElementById('filterPanel'),
          inpWarn     = document.getElementById('warnschwelle'),
          inpTol      = document.getElementById('tolerance'),
          inpMail     = document.getElementById('emailTo'),
          btnSave     = document.getElementById('saveSettings'),
          spanStat    = document.getElementById('saveStatus'),
          container   = document.getElementById('container'),
          filterTyp   = document.getElementById('filterTyp'),
          filterHerst = document.getElementById('filterHersteller'),
          filterSer   = document.getElementById('filterSerie'),
          btnClear    = document.getElementById('btnClearFilters'),
          btnHistView = document.getElementById('btnHistoryView'),
          historyPanel= document.getElementById('historyPanel'),
          historySel  = document.getElementById('historySelect'),
          historyList = document.getElementById('historyList');

    let adminMode=false, warnschwelle=0, tolerance=0, emailTo='', allData=[], filters={typ:null,hersteller:null,serie:null};

    // Admin Login/Logout
    btnAdmin.onclick = ()=>{
      const pw=prompt('Admin-Passwort eingeben:');
      if(pw===ADMIN_PASS){
        adminMode=true;
        settingsDiv.style.display='block';
        btnAdmin.style.display='none';
        btnLogout.style.display='inline-block';
        btnImport.style.display='inline-block';
        loadSettings(); loadFelle();
      } else alert('Falsches Passwort');
    };
    btnLogout.onclick = ()=>{
      adminMode=false;
      settingsDiv.style.display='none';
      filterDiv.style.display='none';
      historyPanel.style.display='none';
      btnLogout.style.display='none';
      btnAdmin.style.display='inline-block';
      btnImport.style.display='none';
      loadFelle();
    };

    // Settings
    async function loadSettings(){
      const res=await fetch(`${URL}/rest/v1/settings?select=warnschwelle,tolerance,email_to&id=eq.global`,{headers});
      const [s]=await res.json();
      warnschwelle=s.warnschwelle; tolerance=s.tolerance; emailTo=s.email_to;
      inpWarn.value=warnschwelle; inpTol.value=tolerance; inpMail.value=emailTo;
    }
    btnSave.onclick=async()=>{
      spanStat.textContent='Speichern…';
      try{
        const body={warnschwelle:parseInt(inpWarn.value,10),tolerance:parseInt(inpTol.value,10),email_to:inpMail.value};
        const r=await fetch(`${URL}/rest/v1/settings?id=eq.global`,{method:'PATCH',headers,body:JSON.stringify(body)});
        if(!r.ok)throw '';
        spanStat.textContent='✔️';
        setTimeout(()=>spanStat.textContent='',1500);
        warnschwelle=body.warnschwelle; tolerance=body.tolerance; emailTo=body.email_to;
      }catch{spanStat.textContent='❌';}
    };

    // Filter toggle
    btnFilter.onclick=()=>{
      filterDiv.style.display=filterDiv.style.display==='block'?'none':'block';
      if(filterDiv.style.display==='block')buildFilterBtns();
    };
    btnClear.onclick=()=>{
      filters={typ:null,hersteller:null,serie:null};
      buildFilterBtns(); renderCards(allData);
    };

    // Load data
    async function loadFelle(){
      container.textContent='Lade Daten…';
      const res=await fetch(`${URL}/rest/v1/felle?select=*,typ_a,typ_b&order=serie.asc`,{headers});
      allData=await res.json();
      buildFilterBtns(); renderCards(allData);
    }

    // Build filter buttons
    function buildFilterBtns(){
      const typs=Array.from(new Set(allData.flatMap(f=>[f.typ_a,f.typ_b].filter(Boolean))));
      const hers=Array.from(new Set(allData.map(f=>f.hersteller)));
      const series=Array.from(new Set(allData.map(f=>f.serie)));
      makeBtns(filterTyp,typs,'typ');
      makeBtns(filterHerst,hers,'hersteller');
      makeBtns(filterSer,series,'serie');
    }
    function makeBtns(ct,arr,key){
      ct.innerHTML='';
      arr.forEach(v=>{
        const b=document.createElement('button');
        b.textContent=v; b.className='btn'+(filters[key]===v?' active-filter':'');
        b.onclick=()=>{filters[key]=filters[key]===v?null:v;makeBtns(ct,arr,key);renderCards(allData)};
        ct.appendChild(b);
      });
    }

    // Render cards
    function renderCards(data){
      container.innerHTML='';
      data.filter(f=>{
        if(filters.typ && !(f.typ_a===filters.typ||f.typ_b===filters.typ))return false;
        if(filters.hersteller && f.hersteller!==filters.hersteller)return false;
        if(filters.serie && f.serie!==filters.serie)return false;
        return true;
      }).forEach(r=>renderCard(r));
    }

    // Render single card
    function renderCard(f){
      const card=document.createElement('div');card.className='card';
      const t=document.createElement('div');t.className='title';
      t.textContent=`${f.hersteller} – ${f.serie} ${f.groesse}`;card.appendChild(t);
      const w=document.createElement('div');w.className='wiki';w.textContent=f.wiki||'';card.appendChild(w);
      const ctr=document.createElement('div');ctr.className='controls';
      if(adminMode){
        const si=document.createElement('input');si.type='number';si.value=f.bestand;si.className='stock-input';
        si.onchange=()=>updateAndLog(f.id,parseInt(si.value,10)-f.bestand);
        ctr.appendChild(si);
      } else {
        const bd=document.createElement('div');bd.innerHTML=`Bestand: <strong>${f.bestand}</strong>`;ctr.appendChild(bd);
      }
      const btns=document.createElement('div');
      ['minus','plus'].forEach(m=>{
        const b=document.createElement('button');b.className=m;b.textContent=m==='minus'?'-1':'+1';
        b.onclick=()=>updateAndLog(f.id,m==='minus'?-1:+1);btns.appendChild(b);
      });
      ctr.appendChild(btns);
      if(adminMode){
        const ti=document.createElement('input');ti.type='number';
        ti.value=f.tolerance_per_item!=null?f.tolerance_per_item:'';ti.placeholder='tol';ti.className='tol-input';
        ti.onchange=()=>updateItem({id:f.id,tolerance_per_item:ti.value===''?null:parseInt(ti.value,10)});
        ctr.appendChild(ti);
      }
      card.appendChild(ctr);container.appendChild(card);
    }

    // Update + log to history
    async function updateAndLog(id,delta){
      if(delta===0) return;
      // 1) patch bestand
      const f = allData.find(x=>x.id===id), neu=f.bestand+delta;
      await fetch(`${URL}/rest/v1/felle?id=eq.${encodeURIComponent(id)}`,{
        method:'PATCH',headers,body:JSON.stringify({bestand:neu})
      });
      // 2) insert history
      await fetch(`${URL}/rest/v1/history`,{
        method:'POST',headers,body:JSON.stringify({fell_id:id,delta})
      });
      // 3) update local
      f.bestand=neu;
      // 4) re-render
      renderCards(allData);
    }

    // History view
    btnHistView.onclick=async()=>{
      filterDiv.style.display='none';
      historyPanel.style.display='block';
      // populate dropdown
      historySel.innerHTML='<option value="">– Fell wählen –</option>';
      allData.forEach(f=>{
        const o=document.createElement('option');
        o.value=f.id; o.textContent=`${f.hersteller}–${f.serie} ${f.groesse}`;
        historySel.appendChild(o);
      });
    };
    historySel.onchange=async()=>{
      const fid=historySel.value;
      if(!fid){ historyList.innerHTML='Keine Historie.'; return; }
      const res=await fetch(`${URL}/rest/v1/history?select=delta,timestamp&fell_id=eq.${encodeURIComponent(fid)}&order=timestamp.desc`,{headers});
      const hs=await res.json();
      historyList.innerHTML=hs.length
        ? hs.map(h=>`<div>${new Date(h.timestamp).toLocaleString()}: ${h.delta>0?'+':''}${h.delta}</div>`).join('')
        : 'Keine Einträge.';
    };

    // CSV Import
    btnImport.onclick=()=>fileInput.click();
    fileInput.onchange=()=>{
      const reader=new FileReader();
      reader.onload=async e=>{
        const lines=e.target.result.split(/\r?\n/).filter(l=>l.trim());
        const sep=lines[0].includes(';')?';':',';
        const [header,...rows]=lines.map(l=>l.split(sep).map(c=>c.trim()));
        const idIdx=header.indexOf('id'), stIdx=header.indexOf('bestand');
        if(idIdx<0||stIdx<0)return alert('CSV needs id and bestand');
        for(const cols of rows){
          const id=cols[idIdx], st=parseInt(cols[stIdx],10);
          if(id && !isNaN(st)){
            await updateAndLog(id, st - (allData.find(x=>x.id===id)||{bestand:0}).bestand);
          }
        }
        alert('Import abgeschlossen');
      };
      reader.readAsText(fileInput.files[0]);
    };

    // CSV Export
    btnExport.onclick=async()=>{
      const r=await fetch(`${URL}/rest/v1/felle`,{headers});
      const data=await r.json();
      if(!data.length)return alert('Keine Daten');
      const sep=';'; const keys=Object.keys(data[0]);
      let csv=keys.join(sep)+'\n';
      data.forEach(f=>csv+=keys.map(k=>f[k]==null?'':String(f[k]).replace(/"/g,'""')).join(sep)+'\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const dlUrl=(window.URL||window.webkitURL).createObjectURL(blob);
      const a=document.createElement('a');a.href=dlUrl;a.download='COPY4DATABASE.csv';
      document.body.appendChild(a);a.click();a.remove();
      (window.URL||window.webkitURL).revokeObjectURL(dlUrl);
    };

    // Warn-Mail unchanged...
    // ...

    await loadSettings();
    await loadFelle();
  });
  </script>
</body>
</html>
