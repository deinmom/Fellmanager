<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Fellmanager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { margin:0; font-family:sans-serif; background:#f5f5f5; }
    header { background:#3182ce; color:white; padding:1rem; text-align:center; font-size:1.5rem; position:sticky; top:0; }
    #toolbar { padding:1rem; display:flex; flex-wrap:wrap; gap:.5rem; background:#fff; justify-content:center; }
    .btn { padding:1rem; border:none; border-radius:.5rem; cursor:pointer; font-size:1.1rem; min-width:3rem; margin:.25rem; }
    .btn-home    { background:#718096; color:white; }
    .btn-admin   { background:#3182ce; color:white; }
    .btn-logout  { background:#e53e3e; color:white; }
    .btn-import  { background:#d69e2e; color:white; }
    .btn-export  { background:#2f855a; color:white; }
    .btn-filter  { background:#4a5568; color:white; }
    .btn-history { background:#805ad5; color:white; }

    #settingsPanel,#filterPanel,#historyPanel { background:#fff; margin:1rem; padding:1rem; border-radius:.5rem; display:none; }
    #filterPanel { text-align:center; }
    #filterPanel .section { margin-top:1rem; text-align:left; font-weight:bold; }
    #menu,#submenu,#cards { padding:1rem; }
    .card { background:#fff; border-radius:1rem; padding:1.5rem; margin:.5rem 1rem; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .title { font-weight:bold; font-size:1.2rem; margin-bottom:.5rem; }
    .wiki  { font-size:.95rem; color:#555; margin:.5rem 0; }
    .controls { display:flex; justify-content:center; align-items:center; gap:1rem; margin-top:.75rem; }
    .controls button { border:none; padding:.8rem 1.2rem; border-radius:.5rem; color:white; cursor:pointer; font-size:1.1rem; min-width:3rem; }
    .minus { background:#e53e3e; }
    .plus  { background:#38a169; }
    input.stock-input,input.tol-input { width:5rem; padding:.5rem; font-size:1rem; margin-right:.5rem; border:1px solid #ccc; border-radius:.25rem; }
    select#historySelect { width:100%; padding:.8rem; font-size:1rem; margin-bottom:.5rem; }
    #historyList div { padding:.5rem 0; font-size:1rem; }
  </style>
</head>
<body>
  <header>Fellmanager</header>
  <div id="toolbar">
    <button id="btnHome"    class="btn btn-home">Home</button>
    <button id="btnAdmin"   class="btn btn-admin">Admin Modus</button>
    <button id="btnLogout"  class="btn btn-logout" style="display:none;">Logout</button>
    <button id="btnImport"  class="btn btn-import" style="display:none;">Import</button>
    <button id="btnExport"  class="btn btn-export">Export</button>
    <button id="btnFilter"  class="btn btn-filter">Filter</button>
    <button id="btnHistory" class="btn btn-history">Historie</button>
    <input  type="file"    id="fileInput" accept=".csv" style="display:none;"/>
  </div>

  <div id="settingsPanel">
    <h2>Einstellungen</h2>
    <label>Warnschwelle: <input type="number" id="warnschwelle"/></label><br/>
    <label>Globale Toleranz: <input type="number" id="tolerance"/></label><br/>
    <label>Warn-Mail an: <input type="email" id="emailTo" style="width:100%;"/></label><br/>
    <button id="saveSettings" class="btn">Speichern</button>
    <span id="saveStatus"></span>
  </div>

  <div id="filterPanel">
    <h2>Filter</h2>
    <div class="section">Typ</div><div id="filterTyp"></div>
    <div class="section">Hersteller</div><div id="filterHersteller"></div>
    <div class="section">Serie</div><div id="filterSerie"></div>
    <button id="btnClearFilters" class="btn">Zurücksetzen</button>
  </div>

  <div id="historyPanel">
    <h2>Historie</h2>
    <select id="historySelect"><option value="">– Fell wählen –</option></select>
    <div id="historyList">Keine Historie.</div>
  </div>

  <div id="menu"></div>
  <div id="submenu" style="display:none;"></div>
  <div id="cards" style="display:none;"></div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const URL     = 'https://owrfgjypnemsxonmbrpj.supabase.co';
    const KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cmZnanlwbmVtc3hvbm1icnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczMTUyOTgsImV4cCI6MjA2Mjg5MTI5OH0.X1PymyDZqNe_Plmao8U6gdqFKP70VrFtuZTesgyZMwg';
    const ADMIN   = 'Admin';
    const headers = { apikey:KEY, Authorization:'Bearer '+KEY };

    let adminMode=false, warn=0, tol=0, mail='', allData=[],
        filters={typ:null,hersteller:null,serie:null},
        curMan=null, curField=null, curValue=null;

    // UI-Refs
    const btnHome    = document.getElementById('btnHome'),
          btnAdmin   = document.getElementById('btnAdmin'),
          btnLogout  = document.getElementById('btnLogout'),
          btnImport  = document.getElementById('btnImport'),
          btnExport  = document.getElementById('btnExport'),
          btnFilter  = document.getElementById('btnFilter'),
          btnHistory = document.getElementById('btnHistory'),
          fileInput  = document.getElementById('fileInput'),
          setPanel   = document.getElementById('settingsPanel'),
          filtPanel  = document.getElementById('filterPanel'),
          histPanel  = document.getElementById('historyPanel'),
          inpWarn    = document.getElementById('warnschwelle'),
          inpTol     = document.getElementById('tolerance'),
          inpMail    = document.getElementById('emailTo'),
          btnSave    = document.getElementById('saveSettings'),
          spanStat   = document.getElementById('saveStatus'),
          filtTyp    = document.getElementById('filterTyp'),
          filtHerst  = document.getElementById('filterHersteller'),
          filtSerie  = document.getElementById('filterSerie'),
          btnClear   = document.getElementById('btnClearFilters'),
          histSelect = document.getElementById('historySelect'),
          histList   = document.getElementById('historyList'),
          menu       = document.getElementById('menu'),
          submenu    = document.getElementById('submenu'),
          cards      = document.getElementById('cards');

    // Lade Einstellungen + Daten
    async function loadSettings(){
      const r = await fetch(`${URL}/rest/v1/settings?select=warnschwelle,tolerance,email_to&id=eq.global`,{headers});
      const [s] = await r.json();
      warn=s.warnschwelle; tol=s.tolerance; mail=s.email_to;
      inpWarn.value=warn; inpTol.value=tol; inpMail.value=mail;
    }
    async function loadData(){
      const r = await fetch(`${URL}/rest/v1/felle?select=*,typ_a,typ_b&order=hersteller,serie,groesse`,{headers});
      allData = await r.json();
    }
    await loadSettings();
    await loadData();

    // Home
    btnHome.onclick = ()=>{
      setPanel.style.display='none';
      filtPanel.style.display='none';
      histPanel.style.display='none';
      submenu.style.display='none';
      menu.style.display='';
      cards.style.display='none';
      btnLogout.style.display = adminMode?'':'none';
      btnImport.style.display = adminMode?'':'none';
      fileInput.style.display = adminMode?'':'none';
      renderMenu();
    };

    // Admin
    btnAdmin.onclick = ()=>{
      const pw = prompt('Admin-Passwort:');
      if(pw===ADMIN){
        adminMode=true;
        setPanel.style.display='';
        btnLogout.style.display='';
        btnImport.style.display='';
        fileInput.style.display='';
        btnAdmin.style.display='none';
      }
    };
    btnLogout.onclick = ()=>{
      adminMode=false;
      setPanel.style.display='none';
      filtPanel.style.display='none';
      histPanel.style.display='none';
      submenu.style.display='none';
      menu.style.display='';
      cards.style.display='none';
      btnLogout.style.display='none';
      btnAdmin.style.display='';
      btnImport.style.display='none';
      fileInput.style.display='none';
    };

    // Import
    fileInput.onchange=async()=>{
      const text=await fileInput.files[0].text();
      const lines=text.split(/\r?\n/).filter(l=>l.trim());
      const sep=lines[0].includes(';')?';':',';
      const [hdr,...rows]=lines.map(l=>l.split(sep).map(c=>c.trim()));
      const idI=hdr.indexOf('id'), stI=hdr.indexOf('bestand');
      for(const cols of rows){
        const id=cols[idI], st=parseInt(cols[stI],10);
        if(id&&!isNaN(st)){
          const old = allData.find(f=>f.id===id).bestand;
          await updateLog(id, st-old);
        }
      }
      alert('Import abgeschlossen');
    };

    // Export (Safari-kompatibel)
    btnExport.onclick=()=>{
      if(!allData.length) return alert('Keine Daten zum Export');
      const sep=';', keys=Object.keys(allData[0]);
      let csv = keys.join(sep)+'\n';
      allData.forEach(f=>{
        csv+=keys.map(k=> f[k]==null?'':String(f[k]).replace(/"/g,'""')).join(sep)+'\n';
      });
      const blob = new Blob([csv],{type:'text/csv'});
      const _URL = window.URL || window.webkitURL;
      const url = _URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'COPY4DATABASE.csv';
      document.body.append(a);
      a.click();
      a.remove();
      _URL.revokeObjectURL(url);
    };

    // Filter
    btnFilter.onclick=()=>{
      filtPanel.style.display = filtPanel.style.display==='block'?'none':'block';
      buildFilters();
    };
    btnClear.onclick=()=>{
      filters={typ:null,hersteller:null,serie:null};
      buildFilters();
      renderMenu();
    };
    function buildFilters(){
      [['typ',filtTyp,['typ_a','typ_b']],
       ['hersteller',filtHerst,['hersteller']],
       ['serie',filtSerie,['serie']]]
      .forEach(([key,cont,fields])=>{
        cont.innerHTML='';
        const vals=Array.from(new Set(
          allData.filter(f=>!filters.hersteller||f.hersteller===filters.hersteller)
                 .flatMap(f=> fields.flatMap(fld=> Array.isArray(f[fld])?f[fld]:[f[fld]]))
                 .filter(Boolean)
        )).sort();
        vals.forEach(v=>{
          const btn = document.createElement('button');
          btn.textContent=v; btn.className='btn';
          if(filters[key]===v) btn.classList.add('btn-admin');
          btn.onclick=()=>{
            filters[key] = filters[key]===v? null : v;
            buildFilters();
            renderMenu();
          };
          cont.appendChild(btn);
        });
      });
    }

    // Historie
    btnHistory.onclick=()=>{
      histPanel.style.display='';
      histSelect.innerHTML='<option></option>';
      allData.forEach(f=> histSelect.add(new Option(`${f.hersteller}–${f.serie} ${f.groesse}`,f.id)));
    };
    histSelect.onchange=async()=>{
      const id=histSelect.value;
      if(!id){ histList.textContent='Keine Historie.'; return; }
      const r = await fetch(`${URL}/rest/v1/history?select=delta,timestamp&fell_id=eq.${encodeURIComponent(id)}&order=timestamp.desc`,{headers});
      const hs=await r.json();
      histList.innerHTML = hs.map(h=>`<div>${new Date(h.timestamp).toLocaleString()}: ${h.delta>0?'+':''}${h.delta}</div>`).join('')||'Keine Einträge.';
    };

    // Menü / Submenu / Karten
    function renderMenu(){
      menu.innerHTML='<h2>Hersteller wählen</h2>';
      submenu.style.display='none'; cards.style.display='none';
      buildFilters();
      Array.from(new Set(allData.map(f=>f.hersteller)))
        .filter(h=>!filters.hersteller||h===filters.hersteller)
        .sort()
        .forEach(m=>{
          const btn=document.createElement('button');
          btn.textContent=m; btn.className='btn';
          btn.onclick=()=>showSub(m);
          menu.appendChild(btn);
        });
    }
    function showSub(man){
      curMan=man;
      menu.style.display='none';
      submenu.style.display='';
      cards.style.display='none';
      submenu.innerHTML=
        '<button class="btn btn-logout">← Zurück</button><br/>' +
        '<button class="btn" id="bSer">Nach Serie</button>' +
        '<button class="btn" id="bTyp" style="margin-left:.5rem">Nach Typ</button>';
      document.getElementById('bSer').onclick=()=>showList('serie');
      document.getElementById('bTyp').onclick=()=>showList('typ');
      submenu.querySelector('.btn-logout').onclick=renderMenu;
    }
    function showList(field){
      curField=field;
      submenu.style.display='none';
      cards.style.display='';
      cards.innerHTML='';
      const back=document.createElement('button');
      back.textContent='← Zurück'; back.className='btn btn-logout';
      back.onclick=()=>showSub(curMan);
      cards.appendChild(back);

      const vals=Array.from(new Set(
        allData.filter(f=>f.hersteller===curMan)
               .flatMap(f=> field==='serie'? [f.serie] : [f.typ_a,f.typ_b].filter(Boolean))
      )).sort();
      vals.forEach(v=>{
        const btn=document.createElement('button');
        btn.textContent=v; btn.className='btn';
        btn.onclick=()=>renderCards(field,v);
        cards.appendChild(btn);
      });
    }
    function renderCards(field,val){
      curValue=val;
      cards.innerHTML='';
      const back=document.createElement('button');
      back.textContent='← Zurück'; back.className='btn btn-logout';
      back.onclick=()=>showList(field);
      cards.appendChild(back);

      allData.filter(f=>f.hersteller===curMan)
             .filter(f=> field==='serie'? f.serie===val : [f.typ_a,f.typ_b].includes(val))
             .forEach(f=>{
        const c=document.createElement('div'); c.className='card';
        c.innerHTML=`
          <div class="title">${f.serie} ${f.groesse}</div>
          <div class="wiki">${f.wiki||''}</div>
          <div class="controls">
            ${ adminMode
               ? `<input class="stock-input" type="number" value="${f.bestand}"
                    onchange="updateLog('${f.id}', parseInt(this.value,10)-${f.bestand})">`
               : `<div>Bestand: <strong>${f.bestand}</strong></div>`
            }
            <button class="minus" onclick="updateLog('${f.id}',-1)">-1</button>
            <button class="plus"  onclick="updateLog('${f.id}',+1)">+1</button>
          </div>`;
        cards.appendChild(c);
      });
    }

    // Update & Log
    window.updateLog=async(id,delta)=>{
      if(!delta) return;
      const f=allData.find(x=>x.id===id), neu=f.bestand+delta;
      await fetch(`${URL}/rest/v1/felle?id=eq.${encodeURIComponent(id)}`,{
        method:'PATCH', headers:{...headers,'Content-Type':'application/json'},
        body:JSON.stringify({bestand:neu})
      });
      await fetch(`${URL}/rest/v1/history`,{
        method:'POST', headers:{...headers,'Content-Type':'application/json'},
        body:JSON.stringify({fell_id:id,delta})
      });
      f.bestand=neu;
      if(curField && curValue) renderCards(curField,curValue);
      else renderMenu();
    };

    // Start
    renderMenu();
  });
  </script>
</body>
</html>
